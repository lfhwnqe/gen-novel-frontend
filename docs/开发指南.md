# 模板开发指南（Template Developer Guide）

本项目是一个基于 Next.js 15 + TypeScript + Tailwind CSS v4 + Shadcn UI 的管理后台模板，采用 Colocation（就近组织）架构，内置鉴权、主题、导航、数据表格与中间件等基础设施，开箱即用、便于扩展。

> 修改应用信息：见 `src/config/app-config.ts`（`APP_CONFIG.name`、`meta.title`、`meta.description`）。

## 在线示例

- 链接：https://main.d3919bjo2q9c5.amplifyapp.com/
- 测试账户：`linuo`
- 测试密码：`Ur8Djfm6vtuf9Lc!`

## 开发环境

- Node.js：建议 `>= 22`；包管理器：`npm` 或 `yarn`
- 开发端口：`npm run dev` 启动在 `http://localhost:3456`
- 环境变量：`API_BASE_URL`（全局代理后端地址）
  - 首次拉取：从 `env.example` 复制到 `.env.development` 与 `.env.production`，再按环境修改值
  - 示例：`env.example` 提供占位；线上需在托管平台（如 Amplify）控制台配置环境变量
- 常用命令：
  - `npm run dev`：本地开发（端口 `3456`）
  - `npm run build`：构建产物
  - `npm run start`：生产运行（端口 `3456`）
  - `npm run lint`：Lint 校验（ESLint）
  - `npm run typecheck`：类型检查（TypeScript）
  - `npm run format` / `npm run format:check`：代码格式化（Prettier）
  - `npm run generate:presets`：生成主题预设（见“主题与偏好”）

## 目录结构（模板视角）

- `src/app`：App Router 路由与页面
  - `(external)`：外部组（例如根路由重定向）
  - `(main)/dashboard/*`：仪表盘功能域与页面（推荐新增功能放这里）
  - `layout.tsx`：根布局，注入主题与偏好
- `src/components`：共享组件
  - `ui/`：Shadcn UI 原子组件
  - `data-table/`：数据表格生态（列头、分页、拖拽等）
  - `layouts/`：布局与页面级复用片段
- `src/navigation/sidebar`：侧边栏菜单与角色过滤（`sidebar-items.ts`）
- `src/lib`：工具方法（`auth.ts`、`utils.ts`、`theme-utils.ts` 等）
- `src/stores`：Zustand 状态（`auth/`、`preferences/`）
- `src/server/server-actions.ts`：服务端 Actions（cookies 偏好读写）
- `src/middleware.ts` + `src/middleware/auth-middleware.ts`：路由保护（见“鉴权与中间件”）
- `src/styles/presets`：主题 CSS 预设；`src/scripts/generate-theme-presets.ts` 生成类型与元数据
- `src/types/preferences/theme.ts`：主题模式与预设类型定义

## 路由与页面

- App Router + Route Groups：
  - `src/app/(external)/page.tsx`：根路由重定向到 `/dashboard`
  - `src/app/(main)/dashboard/layout.tsx`：Dashboard 区域布局与侧边栏
  - `src/app/(main)/dashboard/[...not-found]/page.tsx`：兜底未找到页面
- 重定向：`next.config.mjs` 将 `/dashboard` 定向到 `/dashboard/default`

## 鉴权与中间件

- 令牌存储：
  - 客户端：`localStorage`（`accessToken`、`refreshToken`、`user`）
  - Cookie：`auth-token`（中间件鉴权用）
- 关键方法（`src/lib/auth.ts`）：
  - `setAuthTokens(tokens)`：写入 `localStorage` 与 `auth-token` Cookie，并同步到全局 `auth` Store
  - `logout()`：清除认证信息并重定向到登录页 `/auth/v1/login`
- 中间件（`src/middleware.ts` + `src/middleware/auth-middleware.ts`）：
  - 受保护路径：`/dashboard/:path*`
  - 未登录访问受保护路径 → 重定向 `/auth/v1/login`
  - 已登录访问登录页 → 重定向 `/dashboard`
  - 调整范围：修改 `export const config.matcher` 或中间件逻辑

## API 访问与后端代理

- 全局代理：`next.config.mjs` `rewrites()` 将未被 Next 捕获的请求代理到 `API_BASE_URL`
  - 例如：`fetch('/api/users')` → 代理到 `${API_BASE_URL}/api/users`
- 推荐封装：`src/utils/fetch-with-auth.ts`
  - 自动附带 `Authorization: Bearer <accessToken>`
  - `401` 自动刷新（请求 `/api/auth/refresh`），失败则清空缓存并跳转登录
  - `proxyParams`：在需要后端代理通道的场景透传 `targetPath` 与真实 `method`
- 使用示例：

  ```tsx
  import { useFetchWithAuth } from "@/utils/fetch-with-auth";

  export default function Demo() {
    const fetchAuth = useFetchWithAuth();
    React.useEffect(() => {
      fetchAuth("/api/products", { method: "GET" })
        .then((r) => r.json())
        .then(console.log);
    }, [fetchAuth]);
    return null;
  }
  ```

## 主题与偏好（Theme & Preferences）

- 初始注入（`src/app/layout.tsx`）：
  - 服务端 `getPreference('theme_mode'|'theme_preset')` 从 Cookie 恢复
  - 包裹 `PreferencesStoreProvider`，在客户端通过 `usePreferencesStore` 读取/修改
- 新增主题：
  1. 在 `src/styles/presets/` 新增 `*.css`，包含注释 `label:`、`value:` 以及 `--primary`（light/dark）
  2. 运行 `npm run generate:presets` 更新 `src/types/preferences/theme.ts`
  3. 选择器组件即可自动获得新主题项
- 提交自动化（`.husky/pre-commit`）：
  - 自动执行主题生成与 `prettier` 格式化，随后运行 `lint-staged`

## 菜单与权限（Sidebar & RBAC）

- 配置文件：`src/navigation/sidebar/sidebar-items.ts`
  - `NavGroup` → `items: NavMainItem[]`
  - 通过 `roles: Role[]` 控制菜单可见性（`Role` 见 `src/types/auth.ts`）
  - `filterMenuByRole(menuGroups, userRole)` 会按当前用户角色过滤菜单项
- 开发模式：`IS_DEV` 为 `true` 时会追加演示菜单（Default/CRM/Finance）

## 新增功能模块（推荐流程）

1. 新建目录与页面：

```bash
mkdir -p src/app/\(main\)/dashboard/products/_components
```

```tsx
// src/app/(main)/dashboard/products/page.tsx
export default function ProductsPage() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">产品管理</h1>
      <p className="text-muted-foreground">管理您的产品信息</p>
    </div>
  );
}
```

2. 添加侧边栏菜单：`src/navigation/sidebar/sidebar-items.ts`

```ts
import { Package } from 'lucide-react';

// 在 Dashboards 分组中追加
{
  title: '产品管理',
  url: '/dashboard/products',
  icon: Package,
  roles: [Role.ADMIN, Role.SUPER_ADMIN],
}
```

3. 组织私有组件与表格：`_components/` 中放 `schema.ts`、`columns.tsx`、`data-table.tsx` 等

4. 数据访问：优先使用 `fetch-with-auth`；如需代理通道，设置 `proxyParams`

5. 交互与状态：表单用 `react-hook-form` + `zod`，偏好/轻状态用 `zustand`

## 代码规范与质量

- Lint 校验（ESLint）：`npm run lint`（CI：`npm run lint:ci`）
- 类型检查：`npm run typecheck`
- 代码格式：`npm run format` / `npm run format:check`
- 文件命名：kebab-case（ESLint `unicorn/filename-case`）
- React 规范：避免不稳定嵌套组件、避免数组索引为 key、上下文值需 memo 等（见 `eslint.config.mjs`）
- 构建速度：`next.config.mjs` 在构建时跳过 ESLint/TS 检查；生产建议在 CI 本地先跑 `lint` + `typecheck`

## 环境变量与运行

- `API_BASE_URL`：后端基地址（`rewrites()` 代理目标），通过 `.env.development` / `.env.production` 配置
- 本地开发：`npm run dev` → `http://localhost:3456`
- 构建/运行：`npm run build` → `npm run start`

### 首次拉取与环境变量配置

- 复制示例文件：
  - `cp env.example .env.development`
  - `cp env.example .env.production`
- 编辑变量值：
  - 开发环境：将 `API_BASE_URL` 指向开发后端，例如 API Gateway 开发环境地址：`https://xxxx.execute-api.<region>.amazonaws.com/dev`
  - 生产环境：将 `API_BASE_URL` 指向生产后端，例如：`https://xxxx.execute-api.<region>.amazonaws.com/prod` 或你的自定义域名
- 可选覆盖：
  - 使用 `.env.local` 做个人本地覆盖（已被 `.gitignore` 忽略）；Next.js 会优先加载 `.env.local`
- 说明：
  - `.env.*` 文件已在 `.gitignore` 中忽略，不会提交到仓库
  - 托管环境（如 AWS Amplify）需在控制台设置 `API_BASE_URL` 环境变量
  - 设置完成后执行：`npm ci`，再 `npm run dev`（端口 `3456`）

## 常见问题（FAQ）

- 看不到菜单：确认已登录且 `user.role` 具备访问权限（`sidebar-items.ts` 中 `roles`）
- 401 循环：确认后端实现 `/api/auth/refresh`；或临时关闭自动刷新逻辑
- API 404：检查 `API_BASE_URL` 是否正确；确认 `next.config.mjs` `rewrites()` 生效
- 中间件未生效：检查 `src/middleware.ts` 是否存在、`config.matcher` 是否覆盖目标路径
- 端口不符：模板脚本使用 `3456` 端口（`package.json` `dev/start`）

## 后端与部署（Backend & Deploy）

- 后端模板：`aws-cdk-nestjs-template`（NestJS + AWS CDK）。仓库：https://github.com/lfhwnqe/aws-cdk-nestjs-template
  - 与本前端模板在鉴权（JWT/刷新）、路径代理（`/api/*`）、环境变量（`API_BASE_URL`）等约定上天然匹配。
- 部署建议（AWS Amplify 部署前端）：推荐使用 AWS Amplify Hosting 托管本项目，并将后端使用上述模板部署到 AWS（API Gateway + Lambda 或 ECS/Fargate）。
  - 在 Amplify 控制台为前端配置环境变量 `API_BASE_URL`，指向后端 API Gateway 域名或自定义域名。
  - 建议前后端位于同一 `AWS Account/Region`，降低跨区延迟与权限复杂度。
  - 构建/运行识别：Amplify 能识别 Next.js 应用；如需自定义，可使用 `npm ci && npm run build` 进行构建。
  - 代理说明：本模板 `rewrites()` 会将未被 Next 捕获的 `/api/*` 请求转发到 `API_BASE_URL`。

## 参考与延伸

- 快速开始：`docs/快速开始.md`
- 实战示例：`docs/实战示例.md`
- 查询/操作栏：`docs/query-action-bar.md`
- 代码风格与贡献流程：`AGENTS.md`

— 完 —
